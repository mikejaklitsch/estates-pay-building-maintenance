# Estates Pay Building Maintenance - On Actions
# ═══════════════════════════════════════════════
# Initialization: stamp global PM maps, build location + country indexes
# Monthly: player recalc+charge, AI charge only
# Yearly: AI recalc
# Ownership change: move location between country lists
# ═══════════════════════════════════════════════
# Rebuild version: major * 100 + minor (patch changes don't trigger rebuild)
# Updated by deploy.py from .metadata/metadata.json
@epbm_rebuild_version = 101 # 1.1.x — sync with .metadata/metadata.json
# Bouvet Island (27954): impassable location used as mod state anchor.
# epbm_active modifier applied here — stripped by engine when mod is removed.
# epbm_version variable stored here for version-based rebuild detection.

on_game_start = {
	on_actions = {
		epbm_initialize_all
	}
}

epbm_initialize_all = {
	effect = {
		epbm_full_rebuild = yes
		# Stamp version on Bouvet Island
		location:bouvet_island = {
			remove_location_modifier = epbm_active
			add_location_modifier = { modifier = epbm_active days = -1 }
			set_variable = { name = epbm_version value = @epbm_rebuild_version }
		}
	}
}

# ═══════════════════════════════════════════════
# Version check: runs monthly, triggers rebuild if marker is missing or outdated
# Handles first-time init, version upgrades, and mod remove/re-add
# ═══════════════════════════════════════════════

monthly_country_pulse = {
	on_actions = {
		epbm_version_check
		epbm_player_monthly
		epbm_ai_monthly_charge
	}
}

epbm_version_check = {
	trigger = {
		OR = {
			# Modifier missing = mod was removed and re-added (or first init on existing save)
			location:bouvet_island = {
				NOT = {
					has_location_modifier = epbm_active
				}
			}

			# Modifier present but version outdated = mod was updated
			location:bouvet_island = {
				has_location_modifier = epbm_active
				has_variable = epbm_version
				var:epbm_version < @epbm_rebuild_version
			}
		}

		# Guard: don't let multiple countries trigger rebuild in the same tick
		NOT = {
			has_global_variable = epbm_rebuilding
		}
	}

	effect = {
		set_global_variable = { name = epbm_rebuilding value = yes }
		epbm_full_rebuild = yes
		# Stamp version on Bouvet Island
		location:bouvet_island = {
			remove_location_modifier = epbm_active
			add_location_modifier = { modifier = epbm_active days = -1 }
			set_variable = { name = epbm_version value = @epbm_rebuild_version }
		}

		remove_global_variable = epbm_rebuilding
	}
}

# Player: full recalculation + charge every month

epbm_player_monthly = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
		is_ai = no
		any_estate = { estate_type != estate_type:crown_estate }
	}

	effect = {
		epbm_collect_maintenance = yes
	}
}

# AI: charge estates monthly using saved rates from last yearly calculation

epbm_ai_monthly_charge = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
		is_ai = yes
		is_real_country = yes
		any_estate = { estate_type != estate_type:crown_estate }
	}

	effect = {
		epbm_charge_estates = yes
	}
}

# ═══════════════════════════════════════════════
# Yearly pulse
# ═══════════════════════════════════════════════

yearly_country_pulse = {
	on_actions = {
		epbm_ai_yearly_recalc
		epbm_decade_rebuild
	}
}

# AI: recalculate maintenance rates yearly (expensive iteration)

epbm_ai_yearly_recalc = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
		is_ai = yes
		is_real_country = yes
		any_estate = { estate_type != estate_type:crown_estate }
	}

	effect = {
		epbm_calculate_maintenance = yes
	}
}

# Safety net: rebuild location lists every 10 years to correct any drift

epbm_decade_rebuild = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
		is_real_country = yes
		any_estate = { estate_type != estate_type:crown_estate }
	}

	effect = {
		if = {
			limit = { has_variable = epbm_rebuild_counter var:epbm_rebuild_counter >= 9 }
			epbm_rebuild_location_lists = yes
			set_variable = { name = epbm_rebuild_counter value = 0 }
		}
		else_if = {
			limit = { has_variable = epbm_rebuild_counter }
			change_variable = { name = epbm_rebuild_counter add = 1 }
		}
	}
}

# ═══════════════════════════════════════════════
# Location ownership change: move location between country lists
# root = location, scope:loser = previous owner, scope:winner = new owner
# ═══════════════════════════════════════════════

on_location_changed_owner = {
	on_actions = {
		epbm_on_location_owner_changed
	}
}

epbm_on_location_owner_changed = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
	}

	effect = {
		save_temporary_scope_as = epbm_loc
		# Remove from loser's list (if they have one)
		scope:loser ?= {
			if = {
				limit = {
					has_variable_list = epbm_locations
					is_target_in_variable_list = { name = epbm_locations target = scope:epbm_loc }
				}

				remove_list_variable = { name = epbm_locations target = scope:epbm_loc }
			}
		}

		# Add to winner's list if location has tracked buildings
		scope:winner ?= {
			if = {
				limit = {
					has_variable_list = epbm_locations

					scope:epbm_loc = {
						OR = {
							has_variable_list = epbm_building_types
							has_variable_list = epbm_fort_types
							has_variable_list = epbm_trade_types
						}
					}
					NOT = {
						is_target_in_variable_list = { name = epbm_locations target = scope:epbm_loc }
					}
				}

				add_to_variable_list = { name = epbm_locations target = scope:epbm_loc }
			}
		}
	}
}

# ═══════════════════════════════════════════════
# Global monthly pulse: clear cached PM costs so prices refresh
# ═══════════════════════════════════════════════

weather_monthly_pulse = {
	on_actions = {
		epbm_monthly_cache_clear
	}
}

epbm_monthly_cache_clear = {
	trigger = {
		location:bouvet_island = { has_location_modifier = epbm_active }
	}

	effect = {
		every_in_global_list = {
			variable = epbm_all_ios
			clear_variable_map = epbm_costs
		}
	}
}
